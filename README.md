# Документация для проекта переключения базы данных

## Обзор

Этот проект демонстрирует гибкий способ управления и переключения между несколькими подключениями к базам данных в приложении Spring Boot. Он предоставляет конечные точки API для создания, переключения и закрытия подключений к различным базам данных во время выполнения приложения. Основная функциональность достигается за счет использования пользовательской маршрутизации DataSource.

[Схема работы переключения БД](docs%2Fschema%2Fdb-switch-demo.puml)

## Основные компоненты

### DataSourceConfig

Этот класс отвечает за конфигурацию источников данных. Он определяет начальный источник данных, который используется по умолчанию, и настраивает маршрутизатор для управления несколькими источниками данных.

- **initialDataSource**: Создает начальный источник данных на основе настроек из файла конфигурации.
- **multiRoutingDataSource**: Создает и настраивает `MultiRoutingDataSource`, который отвечает за маршрутизацию между различными источниками данных.

### MultiRoutingDataSource

Этот класс является расширением `AbstractRoutingDataSource` и поддерживает динамическое переключение между различными источниками данных в зависимости от текущего контекста. Он позволяет добавлять новые источники данных в режиме выполнения и автоматически управляет маршрутизацией запросов.

### DataSourceContextHolder

Этот класс управляет текущим контекстом источника данных с использованием `ThreadLocal`. Это позволяет динамически переключать источники данных в зависимости от текущего контекста потока.

### DataSourceServiceImpl

Этот класс реализует основные операции с источниками данных:

- **init**: Инициализация начального источника данных при старте приложения.
- **createDataSource**: Создание нового источника данных. Перед созданием выполняется тестовое подключение к базе данных, чтобы проверить ее доступность.
- **switchDataSource**: Переключение на указанный источник данных.
- **closeDataSource**: Закрытие и удаление источника данных.

### DatabaseSwitchController и DataSourceController

Эти контроллеры предоставляют REST API для управления источниками данных:

- **DatabaseSwitchController**: Обрабатывает запросы на переключение источников данных.
- **DataSourceController**: Обрабатывает запросы на создание и закрытие источников данных.

## Алгоритм работы

1. **Инициализация**: При старте приложения создается начальный источник данных на основе конфигурации из файла `application.yml`.
2. **Создание источника данных**: Пользователь отправляет запрос на создание нового источника данных, указав хост и порт. Система проверяет наличие уже существующего подключения, выполняет тестовое подключение и создает новый источник данных.
3. **Переключение источника данных**: Пользователь отправляет запрос на переключение на другой источник данных. Если указанный источник существует, система переключает текущее соединение на него.
4. **Закрытие источника данных**: Пользователь отправляет запрос на закрытие источника данных. Система закрывает соединение и удаляет его из доступных источников данных.

## Конфигурация

Конфигурация приложения осуществляется через файл `application.yml`:

```yaml
server:
  port: 8080

spring:
  application:
    name: db-switch-demo

  datasource:
    url: jdbc:postgresql://localhost:5433/replica_localhost_5433
    username: user
    password: pass
    driver-class-name: org.postgresql.Driver
    name: replica

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

logging:
  config: classpath:logback.xml
```

Этот файл задает параметры начального подключения к базе данных, включая URL, имя пользователя, пароль и класс драйвера. Также здесь настраиваются параметры JPA и логирования.