# Документация для проекта переключения базы данных

## Обзор

Этот проект демонстрирует гибкий способ управления и переключения между несколькими подключениями к базам данных в приложении Spring Boot с использованием пула соединений HikariCP. Он предоставляет конечные точки API для создания, переключения и закрытия подключений к различным базам данных во время выполнения приложения. Основная функциональность достигается за счет использования пользовательской маршрутизации DataSource и эффективного управления пулом соединений.

[Схема работы переключения БД](docs%2Fschema%2Fdb-switch-demo.puml)

## Основные компоненты

### DataSourceConfig

Этот класс отвечает за конфигурацию источников данных, используя пул соединений HikariCP. Он определяет начальный источник данных, который используется по умолчанию, и настраивает маршрутизатор для управления несколькими источниками данных.

- **createHikariDataSource**: Создает новый источник данных на основе HikariCP, используя параметры подключения к базе данных (URL, имя пользователя, пароль).
- **multiRoutingDataSource**: Создает и настраивает `MultiRoutingDataSource`, который отвечает за маршрутизацию между различными источниками данных.

### MultiRoutingDataSource

Этот класс является расширением `AbstractRoutingDataSource` и поддерживает динамическое переключение между различными источниками данных в зависимости от текущего контекста. Он позволяет добавлять новые источники данных в режиме выполнения и автоматически управляет маршрутизацией запросов. Используя HikariCP, он обеспечивает эффективное управление соединениями к базам данных.

### DataSourceContextHolder

Этот класс управляет текущим контекстом источника данных с использованием `ThreadLocal`. Это позволяет динамически переключать источники данных в зависимости от текущего контекста потока.

### DataSourceServiceImpl

Этот класс реализует основные операции с источниками данных:

- **init**: Инициализация начального источника данных при старте приложения с использованием фиктивного H2 источника данных.
- **createDataSource**: Создание нового источника данных с использованием HikariCP. Перед созданием выполняется тестовое подключение к базе данных, чтобы проверить ее доступность.
- **switchDataSource**: Переключение на указанный источник данных.
- **closeDataSource**: Закрытие и удаление источника данных с очисткой пула соединений.

### DatabaseSwitchController и DataSourceController

Эти контроллеры предоставляют REST API для управления источниками данных:

- **DatabaseSwitchController**: Обрабатывает запросы на переключение источников данных.
- **DataSourceController**: Обрабатывает запросы на создание и закрытие источников данных.

## Конфигурация HikariCP

В проекте используется пул соединений HikariCP для каждого создаваемого источника данных. Пул соединений настраивается через конфигурацию в `application.yml` и используется в методе `createHikariDataSource`.

### Параметры HikariCP:

```yaml
    hikari:
      maximum-pool-size: 10  # Увеличьте значение в зависимости от нагрузки
      minimum-idle: 5        # Минимум свободных соединений
      idle-timeout: 30000    # Таймаут для бездействующих соединений
      max-lifetime: 600000   # Время жизни соединений
      connection-timeout: 30000  # Таймаут для получения соединения
```

### Конфигурация источников данных

Конфигурация приложения осуществляется через файл `application.yml`, где задаются параметры для HikariCP и начального подключения к базе данных:

```yaml
server:
  port: 8080

spring:
  application:
    name: db-switch-demo

  datasource:
    username: user
    password: pass
    driver-class-name: org.postgresql.Driver
    name: replica
    hikari:
      maximum-pool-size: 10  # Увеличьте значение в зависимости от нагрузки
      minimum-idle: 5        # Минимум свободных соединений
      idle-timeout: 30000    # Таймаут для бездействующих соединений
      max-lifetime: 600000   # Время жизни соединений
      connection-timeout: 30000  # Таймаут для получения соединения

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    open-in-view: false

logging:
  config: classpath:logback.xml
```

## Алгоритм работы

1. **Инициализация**: При старте приложения создается начальный "фиктивный" источник данных (H2 in-memory) для поддержки структуры приложения до создания реальных источников данных (`фиктивный источник данных удаляется при первом добавлении реального источника данных`).
2. **Создание источника данных**: Пользователь отправляет запрос на создание нового источника данных, указав хост и порт. Система выполняет тестовое подключение, а затем создает новый источник данных с пулом соединений HikariCP.
3. **Переключение источника данных**: Пользователь отправляет запрос на переключение на другой источник данных. Если указанный источник существует, система переключает текущее соединение на него.
4. **Закрытие источника данных**: Пользователь отправляет запрос на закрытие источника данных. Система закрывает соединение и удаляет его из пула соединений.